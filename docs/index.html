<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>conVerse</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
</head>
<body>
    <header>
        <div class="header">
            <h1>conVerse</h1>
            <div class="user">
                <button 
                    onclick="location.href='demoNFT/index.html'">
                    <p>Generate</p>
                </button>
                <!-- <button id="rinji-button">
                    <p>Connect Wallet</p>
                </button> -->
                <img src="public/icon1.jpg" alt="icon" class="user-icon">
            </div>
        </div>
    </header>

    <main>
        <div class="sidebar">
            <div>
                <h1>Rooms</h1>
                <div class="room here">
                    <p class="icon emoji-span">üòÄ</p>
                    <p>emoji Room</p>
                </div>
                <div class="room">
                    <p class="icon emoji-span">üìù</p>
                    <p>Kanji Room</p>
                </div>
                <div class="room">
                    <p class="icon emoji-span ">üîä</p>
                    <p>Sound Room</p>
                </div>
                <div class="room ">
                    <p class="icon emoji-span">üì∏</p>
                    <p>Picture Room</p>
                </div>
            </div>
            <button id="createRoomButton" class="room createRoom">
                <i class="fa fa-cube" aria-hidden="true"></i>
                <p>Create Room</p>
            </button>
        </div>
        <div class="board">
            <h1><span class="emoji-span">üòÄ</span> emoji Room</h1>
            <!-- <ul id="message-list"/> -->
            <div class="post-set">
                <input id="input-post" type="text" placeholder="Input your message.">
                <button id="add-post">
                    <i class="fa fa-sticky-note-o" aria-hidden="true"></i>
                    <span>Post</span>
                </button>
            </div>
            <div id="container">
            </div>
            <!-- <div id="follower" class="emoji-span"></div> -->
        </div>
    </main>
    <dialog id="createRoomDialog">
        <h1>Create New Room</h1>
        <form>
            <label for="roomIcon">Choose Emoji</label>
            <input type="text" id="roomIcon" name="roomIcon" placeholder="üòÄ">
            <label for="roomName">Name</label>
            <input type="text" id="roomName" name="roomName" placeholder="emoji Room">
            <label for="roomDescription">Rule & Description</label>
            <input type="text" id="roomDescription" name="roomDescription" placeholder="You can only use Emoji in this room.">
            <div class="dialog-button">
                <button id="closeDialog">Close</button>
                <button id="createRoom">Create</button>
            </div>
            </form>
    </dialog>


    <script src="/socket.io/socket.io.js"></script>
    <script>

        let palettes = [["#FFE6C7", "#FFA559", "#FF6000", "#454545"],
                        ["#5D9C59", "#C7E8CA", "#DDF7E3", "#DF2E38"],
                        ["#4CACBC", "#6CC4A1", "#A0D995", "#F6E3C5"],
                        ["#675D50", "#ABC4AA", "#F3DEBA", "#A9907E"],
                        ["#F5F5F5", "#E8E2E2", "#F99417", "#5D3891"],
                        ["#EAE0DA", "#F7F5EB", "#A0C3D2", "#EAC7C7"],
                        ["#82954B", "#BABD42", "#EFD345", "#FFEF82"],
                        ["#146C94", "#19A7CE", "#B0DAFF", "#FEFF86"]
                    ];
    
        let palette = palettes[Math.floor(Math.random() * palettes.length)];
        
        let dataList = [];

        let jsonString = JSON.stringify(dataList);
        localStorage.setItem("dataList", jsonString);



        let x = 0;
        let y = 0;
        let cardId = 0;
        let id = "";
        let color;

        // let cardList = [];

        // inputË¶ÅÁ¥†„ÅÆ‰∏≠Ë∫´„Çí„É™„Çª„ÉÉ„Éà
        function crearText(){
            document.getElementById("add-post").previousElementSibling.value = "";
        }

        window.onload = function () {
            // „Éá„Éº„Çø„ÇíÂâäÈô§
            localStorage.removeItem("dataList");
        }

        // „Çµ„Éº„Éê„ÉºÊé•Á∂öÂë®„Çä
        const addMessageList = (message) => {
            const messageArray = message.split(",");
            const user = messageArray[0];
            const text = messageArray[1];
            const x = messageArray[2];
            const y = messageArray[3];
            const color = messageArray[4];

            // cardList.push({user, text, x, y, color});
            // console.log(cardList);

            let data = {
                userid: user,
                text: text,
                pos: {
                    x: x,
                    y: y
                },
                color: color,
            }

            dataList.push(data);
            jsonString = JSON.stringify(dataList);
            localStorage.setItem("dataList", jsonString);

            addOtherUserCard();
        };

        // ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Åå‰Ωú„Å£„Åü„Ç´„Éº„Éâ„ÇíËøΩÂä†
        function addOtherUserCard(){
            let datas = localStorage.getItem("dataList");
            datas = JSON.parse(datas);
            console.log(datas);
            datas.forEach((cardInfo) => {
                if (cardInfo.userid !== id) {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.style.left = parseInt(cardInfo.pos.x) + "px";
                    card.style.top = parseInt(cardInfo.pos.y) + "px";
                    card.textContent = cardInfo.text;
                    card.style.borderColor = cardInfo.color;
                    card.draggable = false;
                    document.getElementById("container").appendChild(card);
                }
            });
        }

        let cardIndex = 0;
        let isAddingCard = false;

        // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç´„Éº„Éâ„ÅÆËøΩÂä†„ÇíË®±ÂèØ
        document.getElementById("add-post").addEventListener("click", () => {
            isAddingCard = true;
        });


        // document.addEventListener("mousemove", (e) => {
        //     if (isAddingCard) {
        //         const follower = document.getElementById("follower");
        //         const x = e.clientX;
        //         const y = e.clientY;
        //         follower.style = 0.5;
        //         follower.style.left = x + "px";
        //         follower.style.top = y + "px";
        //     }else{
        //         follower.style.opacity = 0;
        //     }
        // });

        // „Ç´„Éº„Éâ„Çí‰Ωú„Çã
        function createCard(x, y) {
            const card = document.createElement("div");
            card.className = "card";
            card.style.left = x + "px";
            card.style.top = y + "px";
            card.textContent = document.getElementById("add-post").previousElementSibling.value;
            card.draggable = false;

            // color = "#" + Math.floor(Math.random() * 16777215).toString(16);

            color = palette[Math.floor(Math.random() * palette.length)];

            card.style.borderColor = color;

            card.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("text/plain", cardIndex);
            });

            document.getElementById("container").appendChild(card);
            cardIndex++;
        }

        const socket = io();
        document.getElementById("container").addEventListener("click", (e) => {
            if(isAddingCard){
                const containerRect = document.getElementById("container").getBoundingClientRect();
                x = e.clientX - containerRect.left;
                y = e.clientY - containerRect.top;
                createCard(x, y);
                isAddingCard = false;

                let inputMessage = document.getElementById("input-post").value;
                if (inputMessage === "") {
                    return;
                }
                
                inputMessage = id + "," + inputMessage + "," + x + "," + y + "," + color;

                socket.emit("sendMessage", inputMessage);
                console.log(inputMessage);

                crearText();
            }
        });

        // Ëá™ÂàÜ„ÅÆ„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
        socket.on("user-id", (userId) => {
            const userIdArray = userId.split(",");
            id = userIdArray[0];
            if(id == ""){
                id = userId.toString();
            }
        });

        // ËøΩÂä†„Åï„Çå„Åü„Ç´„Éº„Éâ„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
        socket.on("receiveMessage", (message) => {
            addMessageList(message);
        });

        // Ëá™ÂàÜ„ÅÆ„Ç´„Éº„Éâ„ÇíËøΩÂä†
        document.getElementById("container").addEventListener("drop", (e) => {
            e.preventDefault();
            cardId = e.dataTransfer.getData("text/plain");
            const card = document.querySelector(".card:nth-child(" + (parseInt(cardId) + 1) + ")");
            if (card) {
                const containerRect = document.getElementById("container").getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const y = e.clientY - containerRect.top;
                card.style.left = x + "px";
                card.style.top = y + "px";
            }
        });
    
        // Create Room Dialog
        // var openButton = document.getElementById("createRoomButton");
        // var dialog = document.getElementById("createRoomDialog");
        // var closeButton = document.getElementById("closeDialog");
        // openButton.addEventListener("click", function () {
        //     dialog.showModal();
        // }, false);
        // closeButton.addEventListener("click", function () {
        //     dialog.close();
        // }, false);
    
    </script>
</body>
</html>